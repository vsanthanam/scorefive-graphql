generator client {
  provider        = "prisma-client"
  output          = "../src/__generated__/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgcrypto()]
}

model User {
  id              String           @id @unique @db.Text
  createdAt       DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime         @updatedAt @db.Timestamptz(6)
  displayName     String           @db.Text
  emailAddress    String?          @db.Text
  emailVerified   Boolean          @default(false)
  savedPlayers    SavedPlayer[]
  games           Game[]
  participantRefs ParticipantRef[]
}

model SavedPlayer {
  id              String           @id @default(uuid()) @db.Uuid
  displayName     String           @db.Text
  owner           User             @relation(fields: [ownerId], references: [id])
  ownerId         String           @db.Text
  participantRefs ParticipantRef[]
}

model Game {
  id                    String                 @id @default(uuid()) @db.Uuid
  createdAt             DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime               @updatedAt @db.Timestamptz(6)
  owner                 User                   @relation(fields: [ownerId], references: [id])
  ownerId               String                 @db.Text
  participantRefs       ParticipantRef[]
  anonymousParticipants AnonymousParticipant[]
  scoreLimit            Int
  hands                 Hand[]
}

model ParticipantRef {
  id                     String                @id @default(uuid()) @db.Uuid
  game                   Game                  @relation(fields: [gameId], references: [id])
  gameId                 String                @db.Uuid
  user                   User?                 @relation(fields: [userId], references: [id])
  userId                 String?               @db.Text
  savedPlayer            SavedPlayer?          @relation(fields: [savedPlayerId], references: [id])
  savedPlayerId          String?               @db.Uuid
  anonymousParticipant   AnonymousParticipant? @relation(fields: [anonymousParticipantId], references: [id])
  anonymousParticipantId String?               @unique @db.Uuid
  turnOrder              Int
  scores                 Score[]

  @@unique([id, gameId])
  @@unique([gameId, turnOrder])
  @@unique([gameId, userId])
  @@unique([gameId, savedPlayerId])
  @@unique([gameId, anonymousParticipantId])
}

model AnonymousParticipant {
  id             String          @id @default(uuid()) @db.Uuid
  displayName    String          @db.Text
  game           Game            @relation(fields: [gameId], references: [id])
  gameId         String          @db.Uuid
  participantRef ParticipantRef?
}

model Hand {
  id         String  @id @default(uuid()) @db.Uuid
  game       Game    @relation(fields: [gameId], references: [id])
  gameId     String  @db.Uuid
  handNumber Int
  scores     Score[]

  @@unique([id, gameId])
  @@unique([gameId, handNumber])
}

model Score {
  id               String         @id @default(uuid()) @db.Uuid
  hand             Hand           @relation(fields: [handId, gameId], references: [id, gameId])
  handId           String         @db.Uuid
  participantRef   ParticipantRef @relation(fields: [participantRefId, gameId], references: [id, gameId])
  participantRefId String         @db.Uuid
  gameId           String         @db.Uuid
  points           Int

  @@unique([handId, participantRefId])
}
